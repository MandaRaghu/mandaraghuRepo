/****** Object:  View [dbo].[EDW.PM_vw_WWOR_Details]    Script Date: 05-22-2020 17:43:14 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE VIEW [dbo].[EDW.PM_vw_WWOR_Details] AS select 	
	[DESC_CUSTOMER_] Customer,
	ClassCode.[CLASSCODE] as CLASS_CODE,
	projdff.[PROJECT_NUMBER_] PROJECT_NUMBER_DFF,
	TASK.[TASKSTRUCTUREBASEPEOELEMENTNUMBER] as Workorder ,
	case when ([EXPENDITURETYPEEXPENDITURETYPENAME] IN('Billable Contract Labor - Doubletime','Billable Contract Labor - Overtime','Billable Contract Labor - Regular','Productive Labor - Doubletime','Productive Labor - Overtime','Productive Labor - Regular'))
	Then sum(case when (pcd.[PROJECTCOSTDISTRIBUTIONPEOQUANTITY] like '%E%') then 0 else
		convert(numeric(25,2),pcd.[PROJECTCOSTDISTRIBUTIONPEOQUANTITY]) end)
	else 0 end as PROD_LABOR_HOURS
	

	from 
	(select  distinct [EXPENDITUREITEMID],[EXPENDITUREITEMPEOPARENTLINENUMBER], [PROJECTCOSTDISTRIBUTIONPEOPROJECTID], [PROJECTCOSTDISTRIBUTIONPEOTASKID], [PROJECTCOSTDISTRIBUTIONPEOPRVDRGLDATE],[PROJECTCOSTDISTRIBUTIONPEOORGID], [PROJECTCOSTDISTRIBUTIONPEOQUANTITY],[PROJECTCOSTDISTRIBUTIONPEOPROJFUNCBURDENEDCOST]  from   [dbo].[temp_EXT_Fscmtopmodelam_pjctransactionsam_projectcostdistributionpvo]) pcd,                                                                                        
	(select distinct  [PROJECTBASEPEOSEGMENT1],[PROJECTCODESPEOTEXTATTR10], [PROJECTCODESPEOTEXTATTR12], [PROJECTID],[PROJECTCODESPEOTEXTATTR03], [PROJECTCODESPEOTEXTATTR11] from [dbo].[temp_EXT_fscmtopmodelam_pjfprojectam_project]) proj,
	(select distinct  [S_K_5000],[PROJECT_NUMBER_],[DESC_CUSTOMER_] from [dbo].[temp_EXT_fscmtopmodelam_pjf_projects_allbiam_flex_bi_pjf_projects_all_vi]) projdff  ,
	(select distinct [FISCALYEARNUMBER],[FISCALPERIODNAME], reportdate, FISCALPERIODSETNAME, FISCALPERIODTYPE,[FISCALPERIODADJUSTMENTPERIODFLAG] from [dbo].[temp_EXT_fscmtopmodelam_finglcalaccam_fiscaldaypvo]) fisday,                                                                                    
	(Select distinct [LEDGERPERIODSETNAME],[LEDGERACCOUNTEDPERIODTYPE],[LEDGERID] from  [dbo].[temp_EXT_fscmtopmodelam_finglledgerdefnam_ledgerpvo] ) ledger,                                                                                       
	(Select distinct [EXPENDITUREITEMID],[EXPENDITUREITEMPEOEXPENDITURETYPEID] from [dbo].[temp_EXT_fscmtopmodelam_pjctransactionsam_expenditureitempvo]) expitem,                                                                                     
	(Select distinct  [EXPENDITURETYPEEXPENDITURECATEGORYID],[EXPENDITURETYPEID],[EXPENDITURETYPEEXPENDITURETYPENAME] from [dbo].[temp_EXT_fscmtopmodelam_pjfsetuptransactionsam_expendituretypeview] ) exptype,                                                                                     
	(select distinct [PJFPROJECTCLASSESPROJECTID], [PJFPROJECTCLASSESCLASSCATEGORYID],[PJFPROJECTCLASSESCLASSCODEID] from [dbo].[temp_EXT_fscmtopmodelam_pjfsetupprojectsam_projectclass] )projclass,                                                                                        
	(Select distinct [CLASSCATEGORYID],[CLASSCATEGORY] from [dbo].[temp_EXT_fscmtopmodelam_pjfsetupprojectsam_classcategorytranslation] ) classcat,                                                                                   
	(select distinct [PROJELEMENTID],[TASKSTRUCTURETRANSLATIONPEONAME], [PROJECTBASEPEOPROJECTID],[TASKSTRUCTUREBASEPEOELEMENTNUMBER],[TASKSTRUCTUREBASEPEOCHARGEABLEFLAG], [TASKSTRUCTUREBASEPEOBILLABLEFLAG],[TASKSTRUCTUREBASEPEOPLANNINGENDDATE]  from [dbo].[temp_EXT_fscmtopmodelam_pjfprojectdefinitionam_taskpvo]) task,
	(select distinct [CALWEEK],[CALWEEKENDDATE]  from [dbo].[temp_EXT_hcmtopmodelanalyticsglobalam_gregoriancalendaram_fndcalweek]) WEK,
	(select distinct [PARENTWEEK], [REPORTDATE] from [dbo].[temp_EXT_hcmtopmodelanalyticsglobalam_gregoriancalendaram_fndcalday]) fndcaldayeo,
	(select distinct [ORGANIZATIONINFORMATIONPEOORGINFORMATION3],ORGANIZATIONINFORMATIONPEOORGANIZATIONID,[ORGANIZATIONINFORMATIONPEOORGINFORMATIONCONTEXT], [EFFECTIVESTARTDATE], [EFFECTIVEENDDATE]  from [dbo].[temp_EXT_hcmtopmodelanalyticsglobalam_organizationam_organizationinformationpvo]) expenditurebupeo,
	(Select distinct [CLASSCODEID],[CLASSCODE] from  temp_EXT_fscmtopmodelam_pjfsetupprojectsam_classcodetranslation) ClassCode,
	(Select distinct [EXPENDITURECATEGORYID],[EXPENDITURECATEGORYNAME]  from temp_EXT_fscmtopmodelam_pjfsetuptransactionsam_expenditurecategorytranslation) ExpCategory

	where pcd.Projectcostdistributionpeoprojectid=proj.[PROJECTID]   
	and projdff.[S_K_5000] =proj.[PROJECTID]                                                                                                                                                                                                                                                        
	and pcd.projectcostdistributionpeoprvdrgldate=fisday.reportdate                                                                                        
	and fisday.FISCALPERIODSETNAME = ledger.[LEDGERPERIODSETNAME]                                                                                   
	AND fisday.FISCALPERIODTYPE = ledger.[LEDGERACCOUNTEDPERIODTYPE]                                                                                       
	and fisday.[FISCALPERIODADJUSTMENTPERIODFLAG]='N'                                                                                        
	and exptype.expendituretypeid=expitem.expenditureitempeoexpendituretypeid                                                                                     
	and expitem.expenditureitemid=pcd.expenditureitemid                                                                                      
	and projclass.[PJFPROJECTCLASSESPROJECTID]=proj.[PROJECTID]                                                                                     
	and projclass.[PJFPROJECTCLASSESCLASSCATEGORYID]=classcat.[CLASSCATEGORYID]                                                                                   
	and classcat.[CLASSCATEGORY]='Line of Business'                                                                                   
	and task.[PROJELEMENTID]=pcd.[projectcostdistributionpeotaskid]                                                                                        
	and task.[PROJECTBASEPEOPROJECTID]=pcd.Projectcostdistributionpeoprojectid                                                                                    
	and task.[PROJECTBASEPEOPROJECTID]=proj.[PROJECTID]                                                                                      
	and fndcaldayeo.[PARENTWEEK]=wek.[CALWEEK] 
	AND pcd.projectcostdistributionpeoprvdrgldate = fndcaldayeo.[REPORTDATE]    
	AND expenditurebupeo.[ORGANIZATIONINFORMATIONPEOORGINFORMATION3] = ledger.[LEDGERID]
	AND pcd.[PROJECTCOSTDISTRIBUTIONPEOORGID] = expenditurebupeo.ORGANIZATIONINFORMATIONPEOORGANIZATIONID
	AND ( 'FUN_BUSINESS_UNIT' ) = expenditurebupeo.[ORGANIZATIONINFORMATIONPEOORGINFORMATIONCONTEXT]
	AND ('2018-03-26' BETWEEN expenditurebupeo.[EFFECTIVESTARTDATE] AND expenditurebupeo.[EFFECTIVEENDDATE])
	AND projclass.[PJFPROJECTCLASSESCLASSCODEID] =ClassCode.[CLASSCODEID]
	AND expCategory.[EXPENDITURECATEGORYID]=exptype.[EXPENDITURETYPEEXPENDITURECATEGORYID]
	AND [DESC_CUSTOMER_]='DUKE ENERGY'
	group by ClassCode.[CLASSCODE],
	TASK.[TASKSTRUCTUREBASEPEOELEMENTNUMBER] ,
	projdff.[PROJECT_NUMBER_],
	[DESC_CUSTOMER_],
	[EXPENDITURETYPEEXPENDITURETYPENAME];
GO


